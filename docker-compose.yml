# =============================================================================
# Ragtime - Self-Hosted Docker Compose
# =============================================================================
# For self-hosted deployment. See README.md for setup instructions.
#
# Usage:
#   1. Create .env file with your configuration
#   2. docker compose up -d
#   3. Access at http://localhost:${PORT:-8000}

services:
  # PostgreSQL database for Prisma persistence
  ragtime-db:
    image: pgvector/pgvector:pg18
    container_name: ragtime-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ragtime
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ragtime
    volumes:
      - ragtime-db-data:/var/lib/postgresql
    networks:
      - ragtime-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ragtime -d ragtime"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ragtime RAG API
  ragtime:
    # For older CPUs without X86_V2 support, use the legacy tag:
    # image: hub.docker.visnovsky.us/library/ragtime:legacy
    image: hub.docker.visnovsky.us/library/ragtime:main
    container_name: ragtime
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      # Database connection (uses container network)
      DATABASE_URL: postgresql://ragtime:${POSTGRES_PASSWORD}@ragtime-db:5432/ragtime
      # Recommended defaults
      DEBUG_MODE: "false"
      RUNTIME_MANAGER_URL: ${RUNTIME_MANAGER_URL:-http://runtime:8090}
      RUNTIME_MANAGER_AUTH_TOKEN: ${RUNTIME_MANAGER_AUTH_TOKEN:-runtime-manager-token}
    volumes:
      # Data persistence (indexes, SSL certs, etc.)
      - ./data:/data
      # Docker socket for container exec (optional, for tool execution)
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # Uncomment below if using SMB/NFS mounting inside container (consider mounting via docker volume instead)
    # privileged: true
    # cap_add:
    #   - SYS_ADMIN
    networks:
      - ragtime-network
    depends_on:
      ragtime-db:
        condition: service_healthy
      runtime:
        condition: service_started
    healthcheck:
      test: ["CMD", "sh", "-c", "if [ \"$ENABLE_HTTPS\" = \"true\" ]; then curl -fsk https://localhost:8000/health; else curl -fs http://localhost:8000/health; fi"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  runtime:
    image: hub.docker.visnovsky.us/library/runtime:main
    container_name: runtime
    restart: unless-stopped
    environment:
      PORT: "8090"
      RUNTIME_SERVICE_MODE: manager
      RUNTIME_MANAGER_AUTH_TOKEN: ${RUNTIME_MANAGER_AUTH_TOKEN:-runtime-manager-token}
      RUNTIME_WORKER_AUTH_TOKEN: ${RUNTIME_WORKER_AUTH_TOKEN:-runtime-worker-token}
      RUNTIME_WORKER_BASE_URL: ${RUNTIME_WORKER_BASE_URL:-http://runtime:8090}
      RUNTIME_WORKSPACE_ROOT: ${RUNTIME_WORKSPACE_ROOT:-/data/_userspace}
      RUNTIME_MAX_SESSIONS: ${RUNTIME_MAX_SESSIONS:-12}
      RUNTIME_LEASE_TTL_SECONDS: ${RUNTIME_LEASE_TTL_SECONDS:-3600}
      RUNTIME_RECONCILE_INTERVAL_SECONDS: ${RUNTIME_RECONCILE_INTERVAL_SECONDS:-15}
    volumes:
      - ./data:/data
    networks:
      - ragtime-network
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  ragtime-network:
    driver: bridge

volumes:
  ragtime-db-data:
