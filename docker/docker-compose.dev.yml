# =============================================================================
# Ragtime - Development Docker Compose
# =============================================================================
# Development compose file for local development with hot-reload.
# Run from repository root: docker compose -f docker/docker-compose.dev.yml up --build

services:
  # PostgreSQL database for Prisma persistence (with pgvector)
  ragtime-db:
    image: pgvector/pgvector:pg18
    container_name: ragtime-db-dev
    ports:
      - "5434:5432"
    environment:
      POSTGRES_USER: ragtime
      POSTGRES_PASSWORD: ragtime_dev
      POSTGRES_DB: ragtime
    volumes:
      - ragtime-db-data:/var/lib/postgresql
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ragtime -d ragtime"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Unified Ragtime service (RAG API + Indexer)
  ragtime:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: ragtime-dev
    # init: true provides tini for zombie reaping as a fallback
    # (Dockerfile.dev also includes tini in ENTRYPOINT)
    init: true
    ports:
      - "${PORT:-8000}:8000"
      - "${API_PORT:-8001}:${API_PORT:-8001}"
    env_file:
      - ../.env
    environment:
      # Database connection (uses container network)
      - DATABASE_URL=postgresql://ragtime:ragtime_dev@ragtime-db:5432/ragtime
      # Development overrides
      - DEBUG_MODE=true
      - ALLOWED_ORIGINS=*
      - INDEX_DATA_PATH=/data
      - API_PORT=${API_PORT:-8001}
      # Authentication settings (from .env file via env_file)
      - JWT_EXPIRE_HOURS=${JWT_EXPIRE_HOURS:-24}
      - SESSION_COOKIE_SECURE=${SESSION_COOKIE_SECURE:-false}
    volumes:
      # Mount source code for hot reload
      - ../ragtime:/ragtime/ragtime
      # Mount scripts folder
      - ../scripts:/ragtime/scripts:ro
      # Mount node_modules as named volume (prevents overwrite by source mount)
      - ragtime-node-modules:/ragtime/ragtime/frontend/node_modules
      # Mount requirements for runtime install
      - ../requirements.txt:/ragtime/requirements.txt:ro
      # Mount Prisma schema for client generation
      - ../prisma:/ragtime/prisma:ro
      # Mount data directory (indexes, SSL certs, etc.)
      - ../.data:/data
      # Mount Docker socket for container exec
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount SSH keys for remote connections
      - ~/.ssh:/root/.ssh:ro
      # Mount scripts for backup/restore
      - ./scripts:/docker-scripts:ro
    privileged: true
    cap_add:
      - SYS_ADMIN
    networks:
      - default
    depends_on:
      ragtime-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  default:
    driver: bridge

volumes:
  ragtime-db-data:
  ragtime-node-modules:  # Persist frontend node_modules across rebuilds
