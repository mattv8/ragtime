// =============================================================================
// Ragtime RAG API - Prisma Schema
// =============================================================================
// Database schema for indexer job and metadata persistence

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Indexer Job Models
// -----------------------------------------------------------------------------

/// Status of an indexing job
enum IndexStatus {
  pending
  processing
  completed
  failed
}

/// Configuration for creating an index (stored as part of job)
model IndexConfig {
  id              String   @id @default(uuid())
  name            String
  description     String   @default("") // Description for LLM context
  filePatterns    String[] @default(["**/*.py", "**/*.md", "**/*.rst", "**/*.txt", "**/*.xml"])
  excludePatterns String[] @default(["**/node_modules/**", "**/__pycache__/**", "**/venv/**", "**/.git/**"])
  chunkSize       Int      @default(1000)
  chunkOverlap    Int      @default(200)
  embeddingModel  String   @default("text-embedding-3-small")

  // Relation to job
  job   IndexJob?
  jobId String?

  @@map("index_configs")
}

/// An indexing job
model IndexJob {
  id     String      @id
  name   String
  status IndexStatus @default(pending)

  // Source information
  sourceType String  @map("source_type") // 'upload' or 'git'
  sourcePath String? @map("source_path")
  gitUrl     String? @map("git_url")
  gitBranch  String  @default("main") @map("git_branch")
  gitToken   String? @map("git_token") // Token for private repo access (kept in DB for job recovery)

  // Progress tracking
  totalFiles      Int     @default(0) @map("total_files")
  processedFiles  Int     @default(0) @map("processed_files")
  totalChunks     Int     @default(0) @map("total_chunks")
  processedChunks Int     @default(0) @map("processed_chunks")
  errorMessage    String? @map("error_message")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Configuration relation
  config   IndexConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  configId String      @unique @map("config_id")

  @@map("index_jobs")
}

/// Metadata for a FAISS index on disk
model IndexMetadata {
  id            String   @id @default(uuid())
  name          String   @unique // Safe tool name (lowercase, alphanumeric with underscores)
  displayName   String?  @map("display_name") // Human-readable name for UI display
  description   String   @default("") // Description for LLM context
  path          String
  documentCount Int      @default(0) @map("document_count")
  chunkCount    Int      @default(0) @map("chunk_count")
  sizeBytes     BigInt   @default(0) @map("size_bytes")
  enabled       Boolean  @default(true) // Include in RAG context
  searchWeight  Float    @default(1.0) @map("search_weight") // Weighting for search prioritization (0.0-10.0)

  // Memory tracking (observed during loading)
  embeddingDimension  Int?    @map("embedding_dimension") // Dimension of vectors in this index
  steadyMemoryBytes   BigInt? @map("steady_memory_bytes") // RAM usage after loading (observed)
  peakMemoryBytes     BigInt? @map("peak_memory_bytes") // Peak RAM during loading (observed)
  loadTimeSeconds     Float?  @map("load_time_seconds") // Time to load this index

  // Source info
  sourceType String  @map("source_type")
  source     String?
  gitBranch  String? @map("git_branch") // Branch for git sources
  gitToken   String? @map("git_token") // Token for private repo access (stored for re-indexing)

  // Config snapshot (JSON)
  configSnapshot Json? @map("config_snapshot")

  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  lastModified DateTime @default(now()) @map("last_modified")

  @@map("index_metadata")
}

// -----------------------------------------------------------------------------
// Application Settings (configurable via UI)
// -----------------------------------------------------------------------------

/// Application settings stored in database
model AppSettings {
  id    String @id @default("default")

  // Server Identity
  serverName    String   @default("Ragtime") @map("server_name") // Customizable server/model name

  // Embedding Configuration (for FAISS indexing)
  embeddingProvider   String   @default("ollama") @map("embedding_provider") // "ollama" or "openai"
  embeddingModel      String   @default("nomic-embed-text") @map("embedding_model")
  embeddingDimensions Int?     @map("embedding_dimensions") // Target dims for OpenAI text-embedding-3-* (MRL)
  // Ollama connection settings (separate fields for UI)
  ollamaProtocol    String   @default("http") @map("ollama_protocol") // "http" or "https"
  ollamaHost        String   @default("localhost") @map("ollama_host")
  ollamaPort        Int      @default(11434) @map("ollama_port")
  ollamaBaseUrl     String   @default("http://localhost:11434") @map("ollama_base_url")

  // LLM Configuration (for chat/RAG responses)
  llmProvider       String   @default("openai") @map("llm_provider") // "openai" or "anthropic"
  llmModel          String   @default("gpt-4-turbo") @map("llm_model")
  openaiApiKey      String   @default("") @map("openai_api_key")
  anthropicApiKey   String   @default("") @map("anthropic_api_key")
  allowedChatModels String[] @default([]) @map("allowed_chat_models") // Empty = all models allowed

  // Legacy tool configuration (deprecated - use ToolConfig table)
  enabledTools      String[] @default([]) @map("enabled_tools")
  odooContainer     String   @default("odoo-server") @map("odoo_container")
  postgresContainer String   @default("odoo-postgres") @map("postgres_container")
  postgresHost      String   @default("") @map("postgres_host")
  postgresPort      Int      @default(5432) @map("postgres_port")
  postgresUser      String   @default("") @map("postgres_user")
  postgresPassword  String   @default("") @map("postgres_password")
  postgresDb        String   @default("") @map("postgres_db")

  // Query Limits
  maxQueryResults   Int      @default(100) @map("max_query_results")
  queryTimeout      Int      @default(30) @map("query_timeout")
  maxIterations     Int      @default(15) @map("max_iterations") // Agent iteration limit

  // Search Configuration
  searchResultsK    Int      @default(5) @map("search_results_k") // Number of results per vector search (k)
  aggregateSearch   Boolean  @default(true) @map("aggregate_search") // If true, use single search_knowledge; if false, create per-index tools

  // Performance / Memory Configuration
  sequentialIndexLoading Boolean @default(false) @map("sequential_index_loading") // Load indexes one-by-one (lower peak RAM) vs parallel (faster)

  // Security
  enableWriteOps    Boolean  @default(false) @map("enable_write_ops")

  // MCP Configuration
  mcpEnabled                  Boolean        @default(false) @map("mcp_enabled") // Enable/disable MCP server
  mcpDefaultRouteAuth         Boolean        @default(false) @map("mcp_default_route_auth") // Require auth for default /mcp route
  mcpDefaultRouteAuthMethod   McpAuthMethod  @default(password) @map("mcp_default_route_auth_method") // Auth method for default route
  mcpDefaultRoutePassword     String?        @map("mcp_default_route_password") // Password for default /mcp route (encrypted)
  mcpDefaultRouteAllowedGroup String?        @map("mcp_default_route_allowed_group") // LDAP group DN for OAuth2 access (optional)

  // Embedding dimension tracking (for detecting provider/model changes)
  // Stored dimension of embeddings in filesystem_embeddings table
  // null = not yet determined (first index will set it)
  embeddingDimension     Int?    @map("embedding_dimension")
  // Hash of provider+model to detect changes (e.g., "ollama:qwen3-embedding:latest")
  embeddingConfigHash    String? @map("embedding_config_hash")

  // Timestamps
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("app_settings")
}

// -----------------------------------------------------------------------------
// Tool Configurations (multiple instances per tool type)
// -----------------------------------------------------------------------------

/// Type of tool connection
enum ToolType {
  postgres
  mssql
  odoo_shell
  ssh_shell
  filesystem_indexer
  solidworks_pdm
}

/// Mount type for filesystem indexer
enum FilesystemMountType {
  docker_volume  // Preferred - fastest, requires container config
  smb            // SMB/CIFS network share
  nfs            // NFS network mount
  local          // Direct local path (container must have access)
}

/// Configuration for a tool instance
model ToolConfig {
  id          String   @id @default(uuid())
  name        String   // User-friendly name (e.g., "Production DB", "Staging Odoo")
  toolType    ToolType @map("tool_type")
  enabled     Boolean  @default(true)

  // Description for RAG context - presented to the model
  description String   @default("")

  // Connection configuration stored as JSON
  // For postgres: host, port, user, password, database, container (optional)
  // For odoo_shell: container, database
  // For ssh_shell: host, port, user, key_path or password, command_prefix
  connectionConfig Json @map("connection_config")

  // Query/execution limits
  maxResults  Int      @default(100) @map("max_results")
  timeout     Int      @default(30) // seconds

  // Security
  allowWrite  Boolean  @default(false) @map("allow_write")

  // Connection test results
  lastTestAt     DateTime? @map("last_test_at")
  lastTestResult Boolean?  @map("last_test_result")
  lastTestError  String?   @map("last_test_error")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relation to filesystem index jobs
  filesystemIndexJobs FilesystemIndexJob[]

  // Relation to MCP route tool selections
  mcpRouteTools McpRouteToolSelection[]

  // Relation to MCP default route filter tool selections
  mcpDefaultRouteFilterTools McpDefaultRouteFilterToolSelection[]

  @@map("tool_configs")
}

// -----------------------------------------------------------------------------
// MCP Route Configuration (custom routes with tool selection)
// -----------------------------------------------------------------------------

/// Authentication method for MCP routes
enum McpAuthMethod {
  password // Static password/API key
  oauth2   // OAuth2 via LDAP authentication
}

/// Custom MCP route configuration
model McpRouteConfig {
  id          String   @id @default(uuid())
  name        String   // User-friendly name (e.g., "Production Tools")
  routePath   String   @unique @map("route_path") // Route suffix (e.g., "my_toolset" for /mcp/my_toolset)
  description String   @default("") // Description for documentation
  enabled     Boolean  @default(true)

  // Authorization settings
  requireAuth    Boolean        @default(false) @map("require_auth") // Require authentication for this route
  authMethod     McpAuthMethod  @default(password) @map("auth_method") // Authentication method
  authPassword   String?        @map("auth_password") // Password/API key for this route (stored encrypted)
  allowedLdapGroup String?      @map("allowed_ldap_group") // LDAP group DN required for OAuth2 access (optional)

  // Built-in tools configuration
  includeKnowledgeSearch Boolean @default(true) @map("include_knowledge_search") // Include search_knowledge tool
  includeGitHistory      Boolean @default(true) @map("include_git_history") // Include git history tools

  // Index selections (for per-index control when aggregate_search is false)
  selectedDocumentIndexes   String[] @default([]) @map("selected_document_indexes") // Document index names to include
  selectedFilesystemIndexes String[] @default([]) @map("selected_filesystem_indexes") // Filesystem tool IDs to include
  selectedSchemaIndexes     String[] @default([]) @map("selected_schema_indexes") // Schema index tool IDs to include

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relation to tool selections
  toolSelections McpRouteToolSelection[]

  @@map("mcp_route_configs")
}

/// Junction table for MCP route to tool config many-to-many relationship
model McpRouteToolSelection {
  id           String @id @default(uuid())
  mcpRouteId   String @map("mcp_route_id")
  toolConfigId String @map("tool_config_id")

  // Relations
  mcpRoute   McpRouteConfig @relation(fields: [mcpRouteId], references: [id], onDelete: Cascade)
  toolConfig ToolConfig     @relation(fields: [toolConfigId], references: [id], onDelete: Cascade)

  @@unique([mcpRouteId, toolConfigId])
  @@map("mcp_route_tool_selections")
}

/// Default MCP route filter - maps LDAP groups to tool subsets
/// When a user authenticates to the default /mcp route, the system checks their
/// LDAP group membership and filters available tools based on these configurations.
/// If no filter matches, all tools are shown (default behavior).
model McpDefaultRouteFilter {
  id          String   @id @default(uuid())
  name        String   // User-friendly name (e.g., "Engineering Tools")
  description String   @default("") // Description for documentation
  enabled     Boolean  @default(true)
  priority    Int      @default(0) // Higher priority filters take precedence

  // LDAP group requirement - user must be member of this group
  ldapGroupDn String   @map("ldap_group_dn") // e.g., "CN=Engineers,OU=Groups,DC=example,DC=com"

  // Built-in tools configuration
  includeKnowledgeSearch Boolean @default(true) @map("include_knowledge_search")
  includeGitHistory      Boolean @default(true) @map("include_git_history")

  // Index selections (for per-index control when aggregate_search is false)
  selectedDocumentIndexes   String[] @default([]) @map("selected_document_indexes")
  selectedFilesystemIndexes String[] @default([]) @map("selected_filesystem_indexes")
  selectedSchemaIndexes     String[] @default([]) @map("selected_schema_indexes")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relation to tool selections
  toolSelections McpDefaultRouteFilterToolSelection[]

  @@unique([ldapGroupDn])
  @@map("mcp_default_route_filters")
}

/// Junction table for default route filter to tool config many-to-many relationship
model McpDefaultRouteFilterToolSelection {
  id           String @id @default(uuid())
  filterId     String @map("filter_id")
  toolConfigId String @map("tool_config_id")

  // Relations
  filter     McpDefaultRouteFilter @relation(fields: [filterId], references: [id], onDelete: Cascade)
  toolConfig ToolConfig            @relation(fields: [toolConfigId], references: [id], onDelete: Cascade)

  @@unique([filterId, toolConfigId])
  @@map("mcp_default_route_filter_tool_selections")
}

// -----------------------------------------------------------------------------
// Filesystem Indexer (pgvector-based)
// -----------------------------------------------------------------------------

/// Filesystem indexing job status
enum FilesystemIndexStatus {
  pending
  indexing
  completed
  failed
  cancelled
}

/// Filesystem indexing job
model FilesystemIndexJob {
  id           String                @id @default(uuid())
  toolConfigId String                @map("tool_config_id")
  toolConfig   ToolConfig            @relation(fields: [toolConfigId], references: [id], onDelete: Cascade)

  status       FilesystemIndexStatus @default(pending)
  indexName    String                @map("index_name")

  // Progress tracking
  totalFiles       Int      @default(0) @map("total_files")
  processedFiles   Int      @default(0) @map("processed_files")
  skippedFiles     Int      @default(0) @map("skipped_files")  // Unchanged files
  totalChunks      Int      @default(0) @map("total_chunks")
  processedChunks  Int      @default(0) @map("processed_chunks")
  errorMessage     String?  @map("error_message")

  // Timing
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@map("filesystem_index_jobs")
}

/// Tracks file metadata for incremental indexing
model FilesystemFileMetadata {
  id           String   @id @default(uuid())
  indexName    String   @map("index_name")
  filePath     String   @map("file_path")  // Relative path within the mount
  fileHash     String   @map("file_hash")  // SHA-256 for change detection
  fileSize     BigInt   @map("file_size")
  mimeType     String?  @map("mime_type")
  chunkCount   Int      @default(0) @map("chunk_count")
  lastIndexed  DateTime @default(now()) @map("last_indexed")

  @@unique([indexName, filePath])
  @@index([indexName])
  @@map("filesystem_file_metadata")
}

/// Vector embeddings stored in pgvector
/// NOTE: Requires pgvector extension: CREATE EXTENSION IF NOT EXISTS vector;
/// The embedding column uses raw SQL for vector type, managed via migration
model FilesystemEmbedding {
  id           String   @id @default(uuid())
  indexName    String   @map("index_name")
  filePath     String   @map("file_path")
  chunkIndex   Int      @map("chunk_index")
  content      String   // The text content of this chunk
  // embedding field is added via raw SQL migration (vector type)

  // Metadata for search context
  metadata     Json     @default("{}")  // Additional context (line numbers, headings, etc.)

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([indexName])
  @@map("filesystem_embeddings")
}

// -----------------------------------------------------------------------------
// Schema Indexer (pgvector-based, for SQL database tools)
// -----------------------------------------------------------------------------

/// Schema indexing job status
enum SchemaIndexStatus {
  pending
  indexing
  completed
  failed
  cancelled
}

/// Schema indexing job (for SQL database tools)
model SchemaIndexJob {
  id           String            @id @default(uuid())
  toolConfigId String            @map("tool_config_id")

  status       SchemaIndexStatus @default(pending)
  indexName    String            @map("index_name")

  // Progress tracking
  totalTables      Int      @default(0) @map("total_tables")
  processedTables  Int      @default(0) @map("processed_tables")
  totalChunks      Int      @default(0) @map("total_chunks")
  processedChunks  Int      @default(0) @map("processed_chunks")
  errorMessage     String?  @map("error_message")

  // Timing
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@map("schema_index_jobs")
}

/// Vector embeddings for SQL database schemas stored in pgvector
/// NOTE: Requires pgvector extension: CREATE EXTENSION IF NOT EXISTS vector;
/// The embedding column uses raw SQL for vector type, managed via migration
model SchemaEmbedding {
  id           String   @id @default(uuid())
  indexName    String   @map("index_name")    // References tool config id or name
  tableName    String   @map("table_name")    // Full table name (schema.table)
  tableSchema  String   @map("table_schema")  // Database schema (e.g., 'public', 'dbo')
  content      String   // The formatted schema text (table + columns + constraints)
  // embedding field is added via raw SQL migration (vector type)

  // Metadata for search context
  metadata     Json     @default("{}")  // Additional context (column count, relations, etc.)

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([indexName, tableName])
  @@index([indexName])
  @@map("schema_embeddings")
}

// -----------------------------------------------------------------------------
// SolidWorks PDM Indexer (pgvector-based, for PDM document metadata)
// -----------------------------------------------------------------------------

/// PDM document indexing job status
enum PdmIndexStatus {
  pending
  indexing
  completed
  failed
  cancelled
}

/// SolidWorks PDM indexing job
model PdmIndexJob {
  id           String         @id @default(uuid())
  toolConfigId String         @map("tool_config_id")

  status       PdmIndexStatus @default(pending)
  indexName    String         @map("index_name")
  currentStep  String?        @map("current_step")  // Current processing step for UI display

  // Progress tracking
  totalDocuments     Int      @default(0) @map("total_documents")
  processedDocuments Int      @default(0) @map("processed_documents")
  skippedDocuments   Int      @default(0) @map("skipped_documents")  // Unchanged documents
  extractedDocuments Int      @default(0) @map("extracted_documents")  // Documents extracted from PDM
  totalChunks        Int      @default(0) @map("total_chunks")
  processedChunks    Int      @default(0) @map("processed_chunks")
  errorMessage       String?  @map("error_message")

  // Timing
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  @@map("pdm_index_jobs")
}

/// PDM document metadata for incremental indexing (change detection)
model PdmDocumentMetadata {
  id           String   @id @default(uuid())
  indexName    String   @map("index_name")
  documentId   Int      @map("document_id")     // PDM DocumentID from SQL Server
  filename     String
  revisionNo   Int      @map("revision_no")
  metadataHash String   @map("metadata_hash")   // Hash of all variables for change detection
  lastIndexed  DateTime @default(now()) @map("last_indexed")

  @@unique([indexName, documentId])
  @@index([indexName])
  @@map("pdm_document_metadata")
}

/// Vector embeddings for SolidWorks PDM documents stored in pgvector
/// NOTE: Requires pgvector extension: CREATE EXTENSION IF NOT EXISTS vector;
/// The embedding column uses raw SQL for vector type, managed via migration
model PdmEmbedding {
  id           String   @id @default(uuid())
  indexName    String   @map("index_name")
  documentId   Int      @map("document_id")
  documentType String   @map("document_type")   // SLDPRT, SLDASM, SLDDRW, etc.
  content      String   // The structured text content
  // embedding field is added via raw SQL migration (vector type)

  // Searchable metadata (duplicated for filtering)
  partNumber   String?  @map("part_number")
  filename     String
  folderPath   String?  @map("folder_path")

  metadata     Json     @default("{}")  // Full variable data as JSON

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([indexName, documentId])
  @@index([indexName])
  @@index([partNumber])
  @@map("pdm_embeddings")
}

// -----------------------------------------------------------------------------
// Authentication & Users
// -----------------------------------------------------------------------------

/// Authentication provider type
enum AuthProvider {
  ldap
  local
}

/// User role for access control
enum UserRole {
  user
  admin
}

/// User account (synced from LDAP or local admin)
model User {
  id            String       @id @default(uuid())
  username      String       @unique // For LDAP: samAccountName/uid, for local: prefixed with "local:"
  authProvider  AuthProvider @default(ldap) @map("auth_provider")
  ldapDn        String?      @map("ldap_dn") // LDAP distinguished name (null for local users)
  email         String?
  displayName   String?      @map("display_name")
  role          UserRole     @default(user)
  lastLoginAt   DateTime?    @map("last_login_at")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")

  // Relations
  sessions      Session[]
  conversations Conversation[]

  @@map("users")
}

/// User session with JWT token
model Session {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  tokenHash   String   @map("token_hash") // Hash of JWT for validation
  expiresAt   DateTime @map("expires_at")
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")

  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// LDAP configuration (stored in database for UI management)
model LdapConfig {
  id              String   @id @default("default")

  // Connection
  serverUrl       String   @default("") @map("server_url") // ldap://host:389 or ldaps://host:636
  bindDn          String   @default("") @map("bind_dn") // Service account DN or samAccountName
  bindPassword    String   @default("") @map("bind_password") // Encrypted
  allowSelfSigned Boolean  @default(false) @map("allow_self_signed") // Skip SSL cert validation

  // Search configuration (auto-discovered or manually set)
  baseDn          String   @default("") @map("base_dn") // e.g., dc=example,dc=com
  userSearchBase  String   @default("") @map("user_search_base") // e.g., ou=Users,dc=example,dc=com
  userSearchFilter String  @default("(|(sAMAccountName={username})(uid={username}))") @map("user_search_filter")

  // Group-based ACL
  adminGroupDn    String   @default("") @map("admin_group_dn") // Members get admin role
  userGroupDn     String   @default("") @map("user_group_dn") // Members get user role (optional, all auth'd users if empty)

  // Discovery cache (JSON array of discovered OUs/groups)
  discoveredOus   Json     @default("[]") @map("discovered_ous")
  discoveredGroups Json    @default("[]") @map("discovered_groups")

  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("ldap_config")
}

// -----------------------------------------------------------------------------
// Chat Conversations
// -----------------------------------------------------------------------------

/// Status of a background chat task
enum ChatTaskStatus {
  pending
  running
  completed
  failed
  cancelled
}

/// A chat conversation with the RAG assistant
model Conversation {
  id        String    @id @default(uuid())
  title     String    @default("New Chat") // Auto-generated from first message or user-set
  model     String    @default("gpt-4-turbo") // Model used for this conversation

  // Owner - null for legacy conversations before auth was added
  userId    String?   @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Messages stored as JSON array
  // Each message: { role: 'user' | 'assistant' | 'system', content: string, timestamp: string }
  messages  Json      @default("[]")

  // Token tracking for context management
  totalTokens Int     @default(0) @map("total_tokens")

  // Background task tracking - active task for this conversation
  activeTaskId String? @map("active_task_id")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relation to background tasks
  tasks     ChatTask[]

  @@map("conversations")
}

/// Background chat task for async message processing
model ChatTask {
  id             String         @id @default(uuid())
  conversationId String         @map("conversation_id")
  status         ChatTaskStatus @default(pending)

  // Input message that triggered this task
  userMessage    String         @map("user_message")

  // Streaming state - stored as JSON
  // Contains: { content: string, events: array, toolCalls: array }
  streamingState Json?          @map("streaming_state")

  // Final response content (populated on completion)
  responseContent String?       @map("response_content")

  // Error info if task failed
  errorMessage   String?        @map("error_message")

  // Timestamps
  createdAt      DateTime       @default(now()) @map("created_at")
  startedAt      DateTime?      @map("started_at")
  completedAt    DateTime?      @map("completed_at")
  lastUpdateAt   DateTime       @default(now()) @map("last_update_at")

  // Relation to conversation
  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("chat_tasks")
}
