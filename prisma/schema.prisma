// =============================================================================
// Ragtime RAG API - Prisma Schema
// =============================================================================
// Database schema for indexer job and metadata persistence

generator client {
  provider             = "prisma-client-py"
  interface            = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Indexer Job Models
// -----------------------------------------------------------------------------

/// Status of an indexing job
enum IndexStatus {
  pending
  processing
  completed
  failed
}

/// Configuration for creating an index (stored as part of job)
model IndexConfig {
  id              String   @id @default(uuid())
  name            String
  description     String   @default("") // Description for LLM context
  filePatterns    String[] @default(["**/*.py", "**/*.md", "**/*.rst", "**/*.txt", "**/*.xml"])
  excludePatterns String[] @default(["**/node_modules/**", "**/__pycache__/**", "**/venv/**", "**/.git/**"])
  chunkSize       Int      @default(1000)
  chunkOverlap    Int      @default(200)
  embeddingModel  String   @default("text-embedding-3-small")

  // Relation to job
  job   IndexJob?
  jobId String?

  @@map("index_configs")
}

/// An indexing job
model IndexJob {
  id     String      @id
  name   String
  status IndexStatus @default(pending)

  // Source information
  sourceType String  @map("source_type") // 'upload' or 'git'
  sourcePath String? @map("source_path")
  gitUrl     String? @map("git_url")
  gitBranch  String  @default("main") @map("git_branch")

  // Progress tracking
  totalFiles      Int     @default(0) @map("total_files")
  processedFiles  Int     @default(0) @map("processed_files")
  totalChunks     Int     @default(0) @map("total_chunks")
  processedChunks Int     @default(0) @map("processed_chunks")
  errorMessage    String? @map("error_message")

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Configuration relation
  config   IndexConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  configId String      @unique @map("config_id")

  @@map("index_jobs")
}

/// Metadata for a FAISS index on disk
model IndexMetadata {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String   @default("") // Description for LLM context
  path          String
  documentCount Int      @default(0) @map("document_count")
  chunkCount    Int      @default(0) @map("chunk_count")
  sizeBytes     BigInt   @default(0) @map("size_bytes")
  enabled       Boolean  @default(true) // Include in RAG context

  // Source info
  sourceType String  @map("source_type")
  source     String?

  // Config snapshot (JSON)
  configSnapshot Json? @map("config_snapshot")

  // Timestamps
  createdAt    DateTime @default(now()) @map("created_at")
  lastModified DateTime @default(now()) @map("last_modified")

  @@map("index_metadata")
}

// -----------------------------------------------------------------------------
// Application Settings (configurable via UI)
// -----------------------------------------------------------------------------

/// Application settings stored in database
model AppSettings {
  id    String @id @default("default")

  // Embedding Configuration (for FAISS indexing)
  embeddingProvider String   @default("ollama") @map("embedding_provider") // "ollama" or "openai"
  embeddingModel    String   @default("nomic-embed-text") @map("embedding_model")
  // Ollama connection settings (separate fields for UI)
  ollamaProtocol    String   @default("http") @map("ollama_protocol") // "http" or "https"
  ollamaHost        String   @default("localhost") @map("ollama_host")
  ollamaPort        Int      @default(11434) @map("ollama_port")
  ollamaBaseUrl     String   @default("http://localhost:11434") @map("ollama_base_url")

  // LLM Configuration (for chat/RAG responses)
  llmProvider       String   @default("openai") @map("llm_provider") // "openai" or "anthropic"
  llmModel          String   @default("gpt-4-turbo") @map("llm_model")
  openaiApiKey      String   @default("") @map("openai_api_key")
  anthropicApiKey   String   @default("") @map("anthropic_api_key")
  allowedChatModels String[] @default([]) @map("allowed_chat_models") // Empty = all models allowed

  // Legacy tool configuration (deprecated - use ToolConfig table)
  enabledTools      String[] @default([]) @map("enabled_tools")
  odooContainer     String   @default("odoo-server") @map("odoo_container")
  postgresContainer String   @default("odoo-postgres") @map("postgres_container")
  postgresHost      String   @default("") @map("postgres_host")
  postgresPort      Int      @default(5432) @map("postgres_port")
  postgresUser      String   @default("") @map("postgres_user")
  postgresPassword  String   @default("") @map("postgres_password")
  postgresDb        String   @default("") @map("postgres_db")

  // Query Limits
  maxQueryResults   Int      @default(100) @map("max_query_results")
  queryTimeout      Int      @default(30) @map("query_timeout")
  maxIterations     Int      @default(15) @map("max_iterations") // Agent iteration limit

  // Security
  enableWriteOps    Boolean  @default(false) @map("enable_write_ops")

  // Timestamps
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("app_settings")
}

// -----------------------------------------------------------------------------
// Tool Configurations (multiple instances per tool type)
// -----------------------------------------------------------------------------

/// Type of tool connection
enum ToolType {
  postgres
  odoo_shell
  ssh_shell
}

/// Configuration for a tool instance
model ToolConfig {
  id          String   @id @default(uuid())
  name        String   // User-friendly name (e.g., "Production DB", "Staging Odoo")
  toolType    ToolType @map("tool_type")
  enabled     Boolean  @default(true)

  // Description for RAG context - presented to the model
  description String   @default("")

  // Connection configuration stored as JSON
  // For postgres: host, port, user, password, database, container (optional)
  // For odoo_shell: container, database
  // For ssh_shell: host, port, user, key_path or password, command_prefix
  connectionConfig Json @map("connection_config")

  // Query/execution limits
  maxResults  Int      @default(100) @map("max_results")
  timeout     Int      @default(30) // seconds

  // Security
  allowWrite  Boolean  @default(false) @map("allow_write")

  // Connection test results
  lastTestAt     DateTime? @map("last_test_at")
  lastTestResult Boolean?  @map("last_test_result")
  lastTestError  String?   @map("last_test_error")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("tool_configs")
}

// -----------------------------------------------------------------------------
// Authentication & Users
// -----------------------------------------------------------------------------

/// Authentication provider type
enum AuthProvider {
  ldap
  local
}

/// User role for access control
enum UserRole {
  user
  admin
}

/// User account (synced from LDAP or local admin)
model User {
  id            String       @id @default(uuid())
  username      String       @unique // For LDAP: samAccountName/uid, for local: prefixed with "local:"
  authProvider  AuthProvider @default(ldap) @map("auth_provider")
  ldapDn        String?      @map("ldap_dn") // LDAP distinguished name (null for local users)
  email         String?
  displayName   String?      @map("display_name")
  role          UserRole     @default(user)
  lastLoginAt   DateTime?    @map("last_login_at")

  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")

  // Relations
  sessions      Session[]
  conversations Conversation[]

  @@map("users")
}

/// User session with JWT token
model Session {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  tokenHash   String   @map("token_hash") // Hash of JWT for validation
  expiresAt   DateTime @map("expires_at")
  userAgent   String?  @map("user_agent")
  ipAddress   String?  @map("ip_address")

  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

/// LDAP configuration (stored in database for UI management)
model LdapConfig {
  id              String   @id @default("default")

  // Connection
  serverUrl       String   @default("") @map("server_url") // ldap://host:389 or ldaps://host:636
  bindDn          String   @default("") @map("bind_dn") // Service account DN or samAccountName
  bindPassword    String   @default("") @map("bind_password") // Encrypted
  allowSelfSigned Boolean  @default(false) @map("allow_self_signed") // Skip SSL cert validation

  // Search configuration (auto-discovered or manually set)
  baseDn          String   @default("") @map("base_dn") // e.g., dc=example,dc=com
  userSearchBase  String   @default("") @map("user_search_base") // e.g., ou=Users,dc=example,dc=com
  userSearchFilter String  @default("(|(sAMAccountName={username})(uid={username}))") @map("user_search_filter")

  // Group-based ACL
  adminGroupDn    String   @default("") @map("admin_group_dn") // Members get admin role
  userGroupDn     String   @default("") @map("user_group_dn") // Members get user role (optional, all auth'd users if empty)

  // Discovery cache (JSON array of discovered OUs/groups)
  discoveredOus   Json     @default("[]") @map("discovered_ous")
  discoveredGroups Json    @default("[]") @map("discovered_groups")

  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("ldap_config")
}

// -----------------------------------------------------------------------------
// Chat Conversations
// -----------------------------------------------------------------------------

/// Status of a background chat task
enum ChatTaskStatus {
  pending
  running
  completed
  failed
  cancelled
}

/// A chat conversation with the RAG assistant
model Conversation {
  id        String    @id @default(uuid())
  title     String    @default("New Chat") // Auto-generated from first message or user-set
  model     String    @default("gpt-4-turbo") // Model used for this conversation

  // Owner - null for legacy conversations before auth was added
  userId    String?   @map("user_id")
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Messages stored as JSON array
  // Each message: { role: 'user' | 'assistant' | 'system', content: string, timestamp: string }
  messages  Json      @default("[]")

  // Token tracking for context management
  totalTokens Int     @default(0) @map("total_tokens")

  // Background task tracking - active task for this conversation
  activeTaskId String? @map("active_task_id")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relation to background tasks
  tasks     ChatTask[]

  @@map("conversations")
}

/// Background chat task for async message processing
model ChatTask {
  id             String         @id @default(uuid())
  conversationId String         @map("conversation_id")
  status         ChatTaskStatus @default(pending)

  // Input message that triggered this task
  userMessage    String         @map("user_message")

  // Streaming state - stored as JSON
  // Contains: { content: string, events: array, toolCalls: array }
  streamingState Json?          @map("streaming_state")

  // Final response content (populated on completion)
  responseContent String?       @map("response_content")

  // Error info if task failed
  errorMessage   String?        @map("error_message")

  // Timestamps
  createdAt      DateTime       @default(now()) @map("created_at")
  startedAt      DateTime?      @map("started_at")
  completedAt    DateTime?      @map("completed_at")
  lastUpdateAt   DateTime       @default(now()) @map("last_update_at")

  // Relation to conversation
  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("chat_tasks")
}
